@page "/stories/{StoryId}"
@inherits UserStateComponentBase

@if (Model != null)
{
    <DocumentTitle Value="@Model.Title" />

    <CascadingValue Value="@Model">
        <PermissionContainer State="@Permissions">
            <div class="entry-detail">
                <h2 class="d-flex title">
                    <InlineTextEdit Value="@Model.Title" ValueChanged="@(async value => await SaveTitleAsync(value))" EditModeCssClass="flex-grow-1" />
                    <div class="ms-1 dropdown">
                        <button class="btn btn-link py-0 px-2" data-bs-toggle="dropdown">
                            <Icon Identifier="ellipsis-v" />
                        </button>
                        <div class="dropdown-menu">
                            <PermissionView Request="@PermissionRequest.Write">
                                <a class="dropdown-item" @onclick="@AddChapter" title="Add Chapter">
                                    <Icon Identifier="book" />
                                    Add Chapter
                                </a>
                                <a class="dropdown-item" @onclick="@(() => SelectEntry(null))" title="Add Story Entry">
                                    <Icon Identifier="comment-alt" />
                                    Add Story Entry
                                </a>
                            </PermissionView>
                            <PermissionView Request="@PermissionRequest.Owner">
                                <ShareButton StoryId="@Model.Id" Layout="ButtonLayout.DropdownItem" />
                            </PermissionView>
                                <ShareLinkButton Layout="ButtonLayout.DropdownItem" />
                            <PermissionView Request="@PermissionRequest.Owner">
                                <hr class="dropdown-divider" />
                                <a class="dropdown-item text-danger" @onclick="@(async () => await DeleteAsync())" title="Delete Story">
                                    <Icon Identifier="trash-alt" />
                                    Delete Story
                                </a>
                            </PermissionView>
                        </div>
                    </div>
                </h2>
                <UserInformation Owner="@Owner" />
                <div class="text">
                    <InlineMarkdownEdit Value="@Model.Text" PlaceHolder="No description..." ValueChanged="@(async value => await SaveTextAsync(value))" />
                </div>
                <div class="entries">
                    <Timeline Data="@Entries[Model.Id]" />
                </div>

                <div class="chapters">
                    @foreach (var chapter in Model.Chapters)
                    {
                        <div class="chapter">
                            <h4 class="d-flex">
                                <InlineTextEdit Value="@chapter.Title" ValueChanged="@(async value => await SaveChapterTitleAsync(chapter, value))" EditModeCssClass="flex-grow-1" />
                                <PermissionView Request="@PermissionRequest.Write">
                                    <div class="ms-1 dropdown">
                                        <button class="btn btn-link py-0 px-2" data-bs-toggle="dropdown">
                                            <Icon Identifier="ellipsis-v" />
                                        </button>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" @onclick="@(() => SelectEntry(chapter))" title="Add Chapter Entry">
                                                <Icon Identifier="plus" />
                                                Add Entry
                                            </a>
                                            <hr class="dropdown-divider" />
                                            <a class="dropdown-item text-danger" @onclick="@(async () => await DeleteChapterAsync(chapter))" title="Delete Chapter">
                                                <Icon Identifier="trash-alt" />
                                                Delete
                                            </a>
                                        </div>
                                    </div>
                                </PermissionView>
                            </h4>
                            <div class="text">
                                <InlineMarkdownEdit Value="@chapter.Text" PlaceHolder="No description..." ValueChanged="@(async value => await SaveChapterTextAsync(chapter, value))" />
                            </div>
                            <div class="entries">
                                <Timeline Data="@Entries[chapter.Id]" />
                            </div>
                        </div>
                    }
                </div>
            </div>
        </PermissionContainer>
    </CascadingValue>

    <EntryPicker @ref="EntryPicker" Selected="EntrySelected" />
}